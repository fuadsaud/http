#!/usr/bin/env ruby
# encoding: UTF-8

$:.unshift File.expand_path(File.join(File.dirname(__FILE__), '../lib'))

require 'http'
require 'clik'

OPTIONS = {
  dir: File.dirname(__FILE__), # Defaults to serving the current dir.
}

def show_help
  puts <<-HELP
Usage: bundle exec http server [-p --port PORT] [-d --dir DIR]
       bundle exec http client [-p --port PORT]

The client is a REPL which takes the path of the required file - without the
leading forward-slash - and prints aout the result.
HELP
end

cli_options = {
  '-p --port' => ->(p) { OPTIONS[:port] = p },
  '-h --help' => -> { show_help and exit }
}

case ARGV.first
when 'server'
  cli cli_options.merge '-d --dir' => ->(d) { OPTIONS[:dir]  = d }

  if OPTIONS[:port]
    HTTP::Server.start(OPTIONS[:dir], OPTIONS[:port])
  else
    HTTP::Server.start(OPTIONS[:dir])
  end
when 'client'
  cli cli_options

  loop do
    print '>> '
    url = ''.tap do |s|
      s << 'http://0.0.0.0'
      s << ":#{OPTIONS[:port]}" if OPTIONS[:port]
      s << "/#{STDIN.gets.chomp}"
    end

    puts HTTP::Client.get(url).to_json
  end
else
  show_help
end
